#!/usr/bin/env bash

source .aocrc

YEAR=${AOC_YEAR:=2024}
LANGUAGE=${AOC_LANGUAGE:=Python}

# Script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

function show_usage {
    echo "AoC Initialization and Run Tool"
    echo ""
    echo "aoc init --day <Day Number> [--lang <Language> --force]"
    echo "  Initializes the day specified with the appropriate language template"
    echo "  This command will set the 'current' day, allowing other commands to omit the switch"
    
    echo "  --day <Day Number> day"
    echo "  --lang specifies a language otherwise the default ($LANGUAGE) is used from .aocrc (or Python)"
    echo "  --force if this day already is initialized, purge and re-initialize THIS IS DESTRUCTIVE"
    echo ""
    echo "aoc fetch [--day <Day Number> --force --wait]"
    echo "  Fetch the desired day AoC input."
    echo "  --day <Day Number> day"
    echo "  --force if this input is already downloaded, force redownload"
    echo "  --wait if before the contest open, will wait until the next start time"
    echo ""
    echo "aoc run|test [--day <Day Number> --lang <Language> --partA --partB]"
    echo "  Run or test a specified day/language for a given part (or both if not specified)"
    echo "  This command will set the 'current' language, allowing other commands to omit the switch"
    echo "  --day <Day Number> day"
    echo "  --lang specifies a language otherwise the default ($LANGUAGE) is used from .aocrc (or Python)"
    echo "  --partA run/test partA"
    echo "  --partB run/test partB"
}

case $LANGUAGE in
    zig)
        # Valid command
        ;;
    *)
        echo "Error: Language: $LANGUAGE" unsupported >&2
        show_usage
        exit 2
        ;;
esac

# Parse command and options
COMMAND=""
DAY=${AOC_DAY:=""}

# First argument is the command
if [[ $# -gt 0 ]]; then
    COMMAND="$1"
    shift
fi

# Validate command
case $COMMAND in
    init)
        if [ -z "$DAY" ] 
        then
            echo "Error: No day specified on init"
            show_usage
            exit 2
        fi
        # Export parsed values for subscripts
        export AOC_DAY="$DAY"
        export AOC_LANGUAGE="$LANGUAGE"
        ;;
    fetch)
        # Valid command
        ;;
    run|test)
        export AOC_LANGUAGE="$LANGUAGE"
        ;;
    "")
        echo "Error: No command specified" >&2
        show_usage
        exit 2
        ;;
    *)
        echo "Error: Unknown command: $COMMAND" >&2
        show_usage
        exit 2
        ;;
esac

# Dispatch to subscript
${SCRIPT_DIR}/aoc-scripts/aoc-${COMMAND}.sh $@
if [ $? -ne 0 ]
then
    show_usage
    exit $?
fi